#!/bin/bash

help ()
{
	echo "dsh - Docker Shell"
	echo "Usage: dsh <command>"
	echo "Commands list:"
	echo 
	echo "	help			Output this help"
	echo "	start (up)		Start vagrant vm and docker containers -OR- restarts containers"
	echo "	stop (down, halt)	Stop vagrant vm"
	echo "	reload (restart)	Re-start vagrant vm and docker containers"
	echo "	status (st)		Show vm/containers status"
	echo "	bash			Start bash on web container"
	echo
}

# checks if binary exists and callable in PATH
binary_found ()
{
	if [[ $1 == '' ]]; then
		return 1;
	fi

	local bpath=`which $1`
	
	if [[ $bpath != '' ]] && [ -f `which $1` ]; then
		return 0
	else
		echo "\"$1\" executable not found."
		return 1
	fi
}

# check that vagrant exists
is_vagrant ()
{
	binary_found 'vagrant';
	return $?
}

# check that docker-compose exists
is_docker_compose ()
{
	binary_found 'docker-compose';
	return $?
}

# check that docker exists
is_docker ()
{
	binary_found 'docker';
	return $?
}

# checks if yml absent
is_yml_absent ()
{
	if [ ! -f './docker-compose.yml' ] ; then
		echo "dsh: docker-compose.yml not found in current directory. Please run dsh from directory where it is located"
		return 0
	fi

	if [ ! -f './Vagrantfile' ] && [ ! -f '../Vagrantfile' ] ; then
		echo "dsh: Vagrantfile not found in current directory. Please run dsh from directory where it is located"
		return 0
	fi

	return 1
}

# checks if vm exists (as per vagrant)
is_vm_exist ()
{
	if is_yml_absent ; then return 2; fi
	if is_vagrant ; then
		res=`vagrant status | grep -e "boot2docker.*not created"`
		if [[ $res == '' ]]; then
			return 0
		else 
			echo "dsh: Vagrant reports that boot2docker vm is not created. Please check you Vagrantfile or run \"dsh up\""
			return 1
		fi
	else
		return 2
	fi
}

# checks if vm is stopped
is_vm_stopped ()
{
	if is_yml_absent ; then return 2; fi
	if is_vagrant ; then
		res=`vagrant status | grep -e "boot2docker.*running"`
		if [[ $res == '' ]]; then
			return 0
		else 
			return 1
		fi
	else
		return 2
	fi
}

# bring box up
up ()
{
	echo "Checking files..."
	if is_yml_absent ; then return 2; fi
	if ! is_vm_exist ; then return 2; fi
	if is_vagrant ; then
		echo "Starting vagrant vm..."
		vagrant up
		started=$?
		if [ $started -eq 0 ] && is_docker_compose ; then
			echo "Starting containers..."
			docker-compose up -d
		fi
	fi
}

# stop box
down ()
{
	if is_yml_absent ; then return 2; fi
	if is_vagrant ; then
		echo "Stopping vagrant vm..."
		vagrant halt
	fi
}

restart ()
{
	echo "Checking files..."
	if is_yml_absent ; then return 2; fi
	if ! is_vm_exist ; then return 2; fi
	if is_vagrant ; then
		echo "Restarting vagrant vm..."
		vagrant reload
		started=$?
		if [ $started -eq 0 ] && is_docker_compose ; then
			echo "Starting containers..."
			docker-compose up -d
		fi
	fi	
}

# output status of boot2docker if stopped or containers if started
status ()
{
	is_vm_stopped
	stopped=$?
	case $stopped in
		2)
			return
			;;
		1)
			if is_docker_compose ; then
				docker-compose ps
			fi
			;;
		0)
			echo "boot2docker is not running"
			if ! is_vm_exist ; then
				return
			else
				echo "Run \"dsh up\" to start boot2docker"
			fi
			;;
	esac
}

_bash ()
{
	if is_docker && is_docker_compose ; then
		docker exec -it $(docker-compose ps -q web) bash -i
		RES=$?
		if [ $RES -ne 0 ]; then
			echo
			echo "dsh: You might want to run \"dsh up\""
		fi
	fi
}

case $1 in
	up)
		up
		;;
	start)
		up
		;;
	stop)
		down
		;;
	down)
		down
		;;
	halt)
		down
		;;
	restart)
		restart
		;;
	reload)
		restart
		;;
	status)
		status
		;;
	st)
		status
		;;
	bash)
		_bash
		;;
	*)
		help
		exit 0
esac